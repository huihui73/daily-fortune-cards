# 每日推算卡 (Daily Fortune Cards)

基于生日、性别和微信授权手机号的日常推荐小程序，通过周易/五行等算法推算出每日的穿搭、饮食、运势等建议。

## 项目概述

**目标**：打造一个基于生日、性别和微信授权手机号的日常推荐小程序，通过周易/五行等算法推算出每日的穿搭、饮食、运势等建议，以卡片式UI展示，提升用户粘性。

**核心价值**
- 趣味性：周易卦象、五行平衡、幸运要素等玄学元素
- 实用性：可执行的穿衣、饮食、微任务建议
- 简洁性：仅需生日+性别+手机号授权，降低使用门槛

## 技术架构

```
┌─────────────────────────────────────────────────────┐
│                    微信小程序端                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  │
│  │首页组件   │  │卡片组件   │  │ FortuneEngine    │  │
│  │(登录+输入)│  │(可折叠卡片)│  │ (本地推算算法)     │  │
│  └──────────┘  └──────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────┐
│                    云开发环境                         │
│  ┌────────────┐  ┌─────────────┐  ┌──────────────┐  │
│  │login云函数  │  │decryptPhone │  │数据库(可选)   │  │
│  │(获取session│  │(解密手机号)   │  │(用户历史数据)  │  │
│  │_key+openid)│  │             │  │              │  │
│  └────────────┘  └─────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────┘
```

## 功能模块

### 1. 用户认证模块

#### 微信小程序端
- **强制手机号授权**：必须授权手机号才能使用完整功能
- wx.login 获取 code → 云函数换取 session_key + openid
- 手机号授权按钮 → 获取 encryptedData + iv
- 云函数解密手机号，脱敏展示
- 本地缓存用户状态
- 认证管理器统一管理登录状态

#### Web端
- **账号密码登录**：支持用户名/邮箱/手机号登录
- 用户注册（账号+密码）
- 密码重置（预留接口）
- JWT Token 认证
- 登录会话管理
- 异常登录检测（预留）

### 2. 输入模块
- 生日选择器（必填）
- 性别单选（可选，默认 unspecified）

### 3. 核心推算引擎
**FortuneEngine.js**
- 基于生日哈希生成确定性种子
- **周易卦象**：种子 → 六爻 → 64卦之一
- **五行平衡**：种子 → 木火土金水强弱分布
- **生命路径数**：生日数字逐位相加 → 1-9
- **幸运要素**：幸运色（9色系）、幸运数字、吉时

### 4. 卡片输出模块
- 卦象解读卡（含变爻建议）
- 五行平衡卡（可视化条形图）
- 幸运要素卡（颜色+数字展示）
- 穿衣灵感卡（基于五行+天气）
- 饮食健康卡（食材方向+搭配模板）
- 微任务卡（今日行动建议）
- 日记 prompts 卡（自省问题）
- 隐私提示卡

## 开发阶段

### Phase 1: MVP 核心功能（1-2周）
- [x] 小程序项目初始化 + 云开发环境搭建
- [ ] 登录/手机号授权流程完整打通
- [ ] FortuneEngine 核心算法实现（卦象+五行+幸运要素）
- [x] CardCard 组件开发（可折叠卡片）
- [ ] 首页 UI + 8张基础卡片展示
- [ ] 本地缓存机制（生日、性别、手机号、上次推算结果）

### Phase 2: 体验优化（1周）
- [ ] 卡片可视化增强（颜色条形图、轮盘组件）
- [ ] 微任务打卡功能
- [ ] 日记功能（保存到本地或云数据库）
- [ ] 每日更新机制（基于日期重新计算）
- [ ] 错误处理与边界情况完善

### Phase 3: 云端能力扩展（1-2周）
- [ ] 云数据库设计（用户表、历史记录表）
- [ ] 用户数据持久化与多设备同步
- [ ] 数据统计（用户留存、卡片点击率）
- [ ] 数据导出/删除功能（隐私合规）

### Phase 4: 内容丰富（持续）
- [ ] 扩展64卦完整解读库
- [ ] 穿衣模板库（按天气/场景）
- [ ] 饮食模板库（按季节/健康目标）
- [ ] 多语言支持
- [ ] 区域化适配

### Phase 5: 商业化探索（可选）
- [ ] 付费高级卡片
- [ ] 深度解读付费版
- [ ] 个性化推荐算法（基于历史选择）
- [ ] 社交分享功能

## 目录结构

```
daily-fortune-cards/
├── miniprogram/              # 小程序前端代码
│   ├── app.js               # 小程序主入口
│   ├── app.json             # 小程序配置
│   ├── app.wxss             # 全局样式
│   ├── utils/               # 工具类
│   │   └── fortuneEngine.js # 核心推算引擎
│   ├── pages/               # 页面
│   │   ├── home/            # 首页
│   │   └── profile/         # 个人中心（待开发）
│   └── components/          # 自定义组件
│       └── CardCard/        # 卡片组件
├── cloudfunctions/          # 云函数
│   ├── login/               # 登录云函数
│   ├── decryptPhone/        # 手机号解密
│   └── getUserData/         # 获取用户数据（待开发）
└── docs/                    # 文档
    ├── API.md               # API文档
    ├── DATABASE.md          # 数据库设计
    └── DEPLOY.md            # 部署指南
```

## 数据模型

### 输入数据
```typescript
interface UserInput {
  birthday: string        // "YYYY-MM-DD"
  gender: "male" | "female" | "other" | "unspecified"
  phone?: string          // 微信授权后获取，脱敏存储
}
```

### 核心推算结果
```typescript
interface FortuneResult {
  hexagramId: number
  hexagramName: string
  hexagramInterpretation: string
  lines: number[]         // [0,1,1,0,1,0] 阴/阳
  lifePathNumber: number  // 1-9
  lifePathDesc: string
  elements: {
    wood: number
    fire: number
    earth: number
    metal: number
    water: number
  }
  luckyColor: string
  luckyNumber: number
}
```

## 快速开始

### 前置要求
1. 安装 [微信开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
2. 注册 [微信小程序账号](https://mp.weixin.qq.com/)
3. 开通云开发服务

### 安装配置

1. 克隆/下载项目到本地
2. 使用微信开发者工具导入项目
3. 在 `project.config.json` 中填入你的 `appid`
4. 在云函数目录下配置环境变量 `APPID` 和 `APPSECRET`
5. 上传并部署云函数
6. 编译运行小程序

## 环境变量配置

在云函数管理页面设置以下环境变量：
- `APPID`: 你的小程序 AppID
- `APPSECRET`: 你的小程序 AppSecret

## 技术选型

| 模块 | 技术方案 | 说明 |
|------|---------|------|
| 小程序框架 | 原生小程序 | 云开发一体化 |
| 语言 | JavaScript | MVP阶段；后续可选TypeScript重构 |
| 状态管理 | 小程序 data + 缓存 | 轻量级 |
| 推算引擎 | 纯本地计算 | 减少依赖，提升响应速度 |
| 云后端 | 微信云开发 | 免运维、快速上线 |
| 数据库 | 云数据库 | 可选，用于持久化 |
| UI组件 | 自研组件 | CardCard为主 |

## 风险与应对

| 风险 | 应对策略 |
|------|---------|
| 手机号授权率低 | 提供"跳过"按钮，核心功能仍可用 |
| 用户质疑玄学准确性 | 明确标注"趣味性"、"仅供参考" |
| 隐私合规问题 | 数据最小化、本地优先、提供删除入口 |
| 内容枯竭/重复感 | 引入天气API、多模板库、随机化元素 |
| 性能问题 | 推算完全本地化，减少网络请求 |

## 隐私说明

本应用遵循最小化数据收集原则：
- **生日**：用于推算算法核心
- **性别**：用于个性化推荐
- **手机号**：仅用于用户身份识别，脱敏存储

所有敏感数据支持本地缓存优先，云端存储最小化，用户可随时请求删除。

## 许可证

MIT License

## 贡献

欢迎提交 Issue 和 Pull Request！

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交 GitHub Issue
- 发送邮件至：your-email@example.com

---

**版本**: v0.1.0 (MVP)
**更新日期**: 2025-01-10
